<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Chat Test - AccrediPro</title>
  <style>
    :root {
      --accredipro-burgundy: #6B2C40;
      --accredipro-gold: #C9A54D;
      --accredipro-cream: #FDF8F3;
      --success: #2AA97B;
      --ink: #1a1a1a;
      --muted: #6b7280;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--accredipro-cream);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }
    .test-header {
      text-align: center;
      margin-bottom: 40px;
    }
    .test-header h1 {
      color: var(--accredipro-burgundy);
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .test-header p {
      color: var(--muted);
    }
    .test-info {
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 40px;
    }
    .test-info h2 {
      color: var(--ink);
      font-size: 1.2rem;
      margin-bottom: 15px;
    }
    .test-info ul {
      list-style: none;
      padding: 0;
    }
    .test-info li {
      padding: 8px 0;
      color: var(--muted);
      border-bottom: 1px solid #f0f0f0;
    }
    .test-info li:last-child {
      border-bottom: none;
    }
    .test-info li strong {
      color: var(--ink);
    }
    .debug-panel {
      background: #1a1a1a;
      color: #00ff00;
      border-radius: 12px;
      padding: 20px;
      max-width: 500px;
      width: 100%;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .debug-panel h3 {
      color: #fff;
      margin-bottom: 10px;
      font-size: 14px;
    }
    #debugLog {
      white-space: pre-wrap;
      word-break: break-all;
    }
    .debug-entry {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
    }
    .debug-time {
      color: #888;
    }
    .debug-success {
      color: #00ff00;
    }
    .debug-error {
      color: #ff4444;
    }
    .debug-info {
      color: #4488ff;
    }

    /* Chat Widget Styles */
    .chat-widget{position:fixed;bottom:20px;right:20px;z-index:9500}
    .chat-window{display:none;position:absolute;bottom:70px;right:0;width:360px;background:#fff;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden}
    .chat-window.open{display:flex;flex-direction:column;max-height:500px}
    .chat-header{background:linear-gradient(135deg,var(--accredipro-burgundy),#5A2435);color:#fff;padding:15px;display:flex;align-items:center;gap:12px}
    .chat-header-avatar{width:45px;height:45px;border-radius:50%;border:2px solid var(--accredipro-gold)}
    .chat-header-info h4{margin:0;font-size:1rem}
    .chat-header-info p{margin:3px 0 0;font-size:.75rem;opacity:.9;display:flex;align-items:center;gap:5px}
    .online-dot{width:8px;height:8px;background:#22c55e;border-radius:50%;display:inline-block;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .chat-header-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;margin-left:auto;opacity:.8}
    .chat-header-close:hover{opacity:1}
    .chat-optin{padding:15px;background:#fff}
    .chat-optin p{font-size:.85rem;color:var(--muted);margin:0 0 12px;text-align:center}
    .chat-optin input{width:100%;border:1px solid #ddd;border-radius:8px;padding:10px 12px;font-size:.85rem;margin-bottom:8px}
    .chat-optin input:focus{outline:none;border-color:var(--accredipro-burgundy)}
    .chat-optin button{width:100%;background:var(--accredipro-burgundy);color:#fff;border:none;padding:12px;border-radius:8px;font-weight:700;font-size:.9rem;cursor:pointer}
    .chat-optin button:hover{background:#5A2435}
    .chat-optin-skip{display:block;text-align:center;margin-top:8px;font-size:.75rem;color:var(--muted);cursor:pointer}
    .chat-optin-skip:hover{color:var(--ink)}
    .chat-messages{flex:1;overflow-y:auto;padding:15px;background:#f9f9f9;min-height:200px;max-height:300px}
    .chat-msg{display:flex;gap:10px;margin-bottom:12px}
    .chat-msg.user{justify-content:flex-end}
    .chat-msg.user .msg-bubble{background:var(--accredipro-burgundy);color:#fff;border-radius:16px 16px 4px 16px}
    .chat-msg.bot .msg-bubble{background:#fff;color:var(--ink);border-radius:16px 16px 16px 4px;border:1px solid #e5e5e5}
    .msg-avatar{width:32px;height:32px;border-radius:50%;flex-shrink:0}
    .msg-bubble{padding:10px 14px;max-width:240px;font-size:.9rem;line-height:1.4;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .typing-indicator{display:flex;gap:4px;padding:10px 14px;background:#fff;border-radius:16px;border:1px solid #e5e5e5}
    .typing-indicator span{width:8px;height:8px;background:#ccc;border-radius:50%;animation:typing 1.4s infinite}
    .typing-indicator span:nth-child(2){animation-delay:.2s}
    .typing-indicator span:nth-child(3){animation-delay:.4s}
    @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-4px)}}
    .chat-input-area{display:flex;gap:8px;padding:12px;background:#fff;border-top:1px solid #eee}
    .chat-input{flex:1;border:1px solid #ddd;border-radius:20px;padding:10px 16px;font-size:.9rem}
    .chat-input:focus{outline:none;border-color:var(--accredipro-burgundy)}
    .chat-send{width:40px;height:40px;border-radius:50%;background:var(--accredipro-burgundy);color:#fff;border:none;cursor:pointer;font-size:16px}
    .chat-send:hover{background:#5A2435}
    .chat-bubble{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--accredipro-burgundy),#5A2435);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(107,44,64,.4);position:relative;transition:transform .2s}
    .chat-bubble:hover{transform:scale(1.05)}
    .chat-bubble img{width:42px;height:42px;border-radius:50%;border:2px solid var(--accredipro-gold)}
    .chat-pulse{position:absolute;inset:-4px;border-radius:50%;background:var(--accredipro-burgundy);opacity:.3;animation:chatPulse 2s infinite}
    @keyframes chatPulse{0%{transform:scale(1);opacity:.3}100%{transform:scale(1.3);opacity:0}}
    .chat-status{position:absolute;bottom:2px;right:2px;width:14px;height:14px;background:#22c55e;border-radius:50%;border:2px solid #fff}
    .chat-label{position:absolute;bottom:70px;right:0;background:#fff;padding:10px 16px;border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.1);font-size:.85rem;white-space:nowrap;color:var(--ink);transition:opacity .3s}
  </style>
</head>
<body>
  <div class="test-header">
    <h1>Live Chat Test Page</h1>
    <p>Testing the Sarah AI chat widget</p>
  </div>

  <div class="test-info">
    <h2>Test Instructions</h2>
    <ul>
      <li><strong>1.</strong> Click the chat bubble in the bottom right</li>
      <li><strong>2.</strong> Enter your name (or skip)</li>
      <li><strong>3.</strong> Send a message to Sarah</li>
      <li><strong>4.</strong> Check the debug panel for API responses</li>
      <li><strong>5.</strong> Verify in <a href="/admin/live-chat" target="_blank">/admin/live-chat</a></li>
    </ul>
  </div>

  <div class="debug-panel">
    <h3>Debug Log</h3>
    <div id="debugLog"></div>
  </div>

  <!-- Chat Widget -->
  <div class="chat-widget" id="chatWidget">
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <img src="https://assets.accredipro.academy/migrated/Sarah-M.webp" alt="Sarah" class="chat-header-avatar">
        <div class="chat-header-info">
          <h4>Sarah</h4>
          <p><span class="online-dot"></span> Online now</p>
        </div>
        <button class="chat-header-close" onclick="toggleChat()">âœ•</button>
      </div>
      <div class="chat-optin" id="chatOptin">
        <p>Hey, Sarah here! How should I call you? ðŸ˜Š</p>
        <input type="text" id="chatUserName" placeholder="Your first name">
        <input type="email" id="chatUserEmail" placeholder="Your email (in case I'm offline)">
        <button onclick="startChat()">Let's Chat!</button>
        <span class="chat-optin-skip" onclick="skipOptin()">Skip, just let me ask a question</span>
      </div>
      <div id="chatArea" style="display:none">
        <div class="chat-messages" id="chatMessages">
          <div class="chat-msg bot">
            <img src="https://assets.accredipro.academy/migrated/Sarah-M.webp" alt="Sarah" class="msg-avatar">
            <div class="msg-bubble">Hey there! ðŸ‘‹ I'm Sarah. Ask me anything about the FM Certification!</div>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chatInput" placeholder="Type your question..." onkeypress="handleChatKeypress(event)">
          <button class="chat-send" onclick="sendChatMessage()">âž¤</button>
        </div>
      </div>
    </div>
    <div class="chat-bubble" onclick="toggleChat()">
      <div class="chat-pulse"></div>
      <img src="https://assets.accredipro.academy/migrated/Sarah-M.webp" alt="Sarah">
      <div class="chat-status"></div>
    </div>
    <div class="chat-label">Chat with Sarah ðŸ’¬</div>
  </div>

  <script>
  // Debug logging
  function debugLog(type, message) {
    const log = document.getElementById('debugLog');
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.className = 'debug-entry';
    entry.innerHTML = `<span class="debug-time">[${time}]</span> <span class="debug-${type}">${message}</span>`;
    log.insertBefore(entry, log.firstChild);
  }

  // Chat state
  let chatVisitorId = localStorage.getItem('chatVisitorId') || 'visitor_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('chatVisitorId', chatVisitorId);
  let chatUserName = localStorage.getItem('chatUserName') || '';
  let chatUserEmail = localStorage.getItem('chatUserEmail') || '';

  debugLog('info', 'Visitor ID: ' + chatVisitorId);

  function toggleChat() {
    const chatWindow = document.getElementById('chatWindow');
    const chatLabel = document.querySelector('.chat-label');
    chatWindow.classList.toggle('open');
    if (chatWindow.classList.contains('open')) {
      chatLabel.style.display = 'none';
      debugLog('info', 'Chat opened');
      if (chatUserName) {
        document.getElementById('chatOptin').style.display = 'none';
        document.getElementById('chatArea').style.display = 'flex';
        document.getElementById('chatArea').style.flexDirection = 'column';
      }
    }
  }

  async function startChat() {
    const nameInput = document.getElementById('chatUserName');
    const emailInput = document.getElementById('chatUserEmail');
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();

    if (!name) {
      nameInput.style.borderColor = '#ef4444';
      nameInput.focus();
      return;
    }

    chatUserName = name;
    chatUserEmail = email;
    localStorage.setItem('chatUserName', name);
    if (email) localStorage.setItem('chatUserEmail', email);

    debugLog('info', 'Saving optin to database...');

    // Save optin to database immediately
    const apiBase = window.location.hostname === 'localhost' ? '' : 'https://learn.accredipro.academy';
    const optinUrl = apiBase + '/api/chat/optin';

    try {
      const response = await fetch(optinUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          visitorId: chatVisitorId,
          name: name,
          email: email || null,
          page: 'chat-test'
        })
      });
      const data = await response.json();
      if (data.success) {
        debugLog('success', 'Optin saved to DB! ID: ' + (data.optinId || 'skipped'));
      } else {
        debugLog('error', 'Optin save failed: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      debugLog('error', 'Optin API error: ' + err.message);
    }

    debugLog('success', 'User opted in: ' + name + (email ? ' (' + email + ')' : ''));

    document.getElementById('chatOptin').style.display = 'none';
    document.getElementById('chatArea').style.display = 'flex';
    document.getElementById('chatArea').style.flexDirection = 'column';

    const messagesDiv = document.getElementById('chatMessages');
    messagesDiv.innerHTML = `
      <div class="chat-msg bot">
        <img src="https://assets.accredipro.academy/migrated/Sarah-M.webp" alt="Sarah" class="msg-avatar">
        <div class="msg-bubble">Hey ${name}! ðŸ‘‹ Nice to meet you! Ask me anything about the FM Certification!</div>
      </div>
    `;

    document.getElementById('chatInput').focus();
  }

  function skipOptin() {
    chatUserName = 'Friend';
    debugLog('info', 'User skipped optin');
    document.getElementById('chatOptin').style.display = 'none';
    document.getElementById('chatArea').style.display = 'flex';
    document.getElementById('chatArea').style.flexDirection = 'column';
    document.getElementById('chatInput').focus();
  }

  function handleChatKeypress(e) {
    if (e.key === 'Enter') sendChatMessage();
  }

  function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    const messagesDiv = document.getElementById('chatMessages');

    messagesDiv.innerHTML += `
      <div class="chat-msg user">
        <div class="msg-bubble">${message}</div>
      </div>
    `;
    input.value = '';
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    debugLog('info', 'Sending message: ' + message.substring(0, 50) + '...');

    const typingId = 'typing-' + Date.now();
    messagesDiv.innerHTML += `
      <div class="chat-msg bot" id="${typingId}">
        <img src="https://assets.accredipro.academy/migrated/Sarah-M.webp" alt="Sarah" class="msg-avatar">
        <div class="typing-indicator"><span></span><span></span><span></span></div>
      </div>
    `;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    const apiBase = window.location.hostname === 'localhost' ? '' : 'https://learn.accredipro.academy';
    const apiUrl = apiBase + '/api/chat/sales';

    debugLog('info', 'API URL: ' + apiUrl);

    fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message,
        page: 'chat-test',
        visitorId: chatVisitorId,
        userName: chatUserName,
        userEmail: chatUserEmail
      })
    })
    .then(res => {
      debugLog('info', 'Response status: ' + res.status);
      return res.json();
    })
    .then(data => {
      document.getElementById(typingId).remove();
      debugLog('success', 'AI replied: ' + (data.reply || 'No reply').substring(0, 50) + '...');
      messagesDiv.innerHTML += `
        <div class="chat-msg bot">
          <img src="https://assets.accredipro.academy/migrated/Sarah-M.webp" alt="Sarah" class="msg-avatar">
          <div class="msg-bubble">${data.reply || "Thanks for your question!"}</div>
        </div>
      `;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    })
    .catch(err => {
      document.getElementById(typingId).remove();
      debugLog('error', 'Error: ' + err.message);
      messagesDiv.innerHTML += `
        <div class="chat-msg bot">
          <img src="https://assets.accredipro.academy/migrated/Sarah-M.webp" alt="Sarah" class="msg-avatar">
          <div class="msg-bubble">Sorry, I couldn't connect. Please try again!</div>
        </div>
      `;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // Hide label after 5 seconds
  setTimeout(() => {
    const label = document.querySelector('.chat-label');
    if (label) label.style.opacity = '0';
    setTimeout(() => { if (label) label.style.display = 'none'; }, 500);
  }, 5000);

  debugLog('success', 'Chat widget initialized');
  </script>
</body>
</html>
