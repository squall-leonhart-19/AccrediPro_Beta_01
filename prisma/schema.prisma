// AccrediPro LMS Database Schema
// Premium LMS for 40+ US Women - Certifications & Mini-Diplomas

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== USER & AUTH ====================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  emailVerified     DateTime?
  passwordHash      String?
  firstName         String?
  lastName          String?
  avatar            String?
  bio               String?
  phone             String?
  location          String?   // City, State
  timezone          String?
  role              UserRole  @default(STUDENT)
  isActive          Boolean   @default(true)
  hasCompletedOnboarding Boolean @default(false)
  hasCompletedProfile Boolean @default(false)
  lastLoginAt       DateTime?
  firstLoginAt      DateTime? // Track first ever login
  loginCount        Int       @default(0)
  leadSource        String?   // Where they came from (freebie, webinar, etc.)
  leadSourceDetail  String?   // Specific detail (which freebie, etc.)
  assignedCoachId   String?   // Auto-assigned coach based on category

  // Mini Diploma Freebie (Lead Magnet)
  miniDiplomaCategory String?  // functional-medicine, autism, gut-health, etc.
  miniDiplomaOptinAt  DateTime? // When they opted in
  miniDiplomaCompletedAt DateTime? // When they completed the mini diploma
  graduateOfferDeadline DateTime? // 3-day countdown for graduate discount
  hasCertificateBadge Boolean @default(false) // Has mini diploma badge

  // Profile/Onboarding Data
  healthBackground  String?   // Their health journey
  certificationGoal String?   // What certification they're working towards
  learningGoal      String?   // Career change, add to practice, personal
  weeklyHours       Int?      // Hours available per week
  experienceLevel   String?   // Beginner, Some experience, Professional
  focusAreas        String[]  // Specific health areas of interest

  // Mentor Profile Fields (for coaches/instructors)
  qualifications    String[]  // Certifications, degrees
  personalQuote     String?   // Motivational quote
  avgResponseTime   Int?      // Average response time in minutes
  specialties       String[]  // Areas of expertise
  availabilityNote  String?   // e.g., "Replies within 24 hours"
  level             Int       @default(1)  // Gamification level
  xp                Int       @default(0)  // Experience points

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  accounts          Account[]
  sessions          Session[]
  enrollments       Enrollment[]
  progress          LessonProgress[]
  certificates      Certificate[]
  sentMessages      Message[]         @relation("SentMessages")
  receivedMessages  Message[]         @relation("ReceivedMessages")
  scheduledVoiceSent     ScheduledVoiceMessage[] @relation("ScheduledVoiceSender")
  scheduledVoiceReceived ScheduledVoiceMessage[] @relation("ScheduledVoiceReceiver")
  communityPosts    CommunityPost[]
  postComments      PostComment[]
  notifications     Notification[]
  mentorSessions    MentorSession[]   @relation("MentorSessions")
  bulkEmailsSent    BulkEmail[]       @relation("BulkEmailSender")
  bulkDMsSent       BulkDM[]          @relation("BulkDMSender")
  studentSessions   MentorSession[]   @relation("StudentSessions")
  passwordResets    PasswordReset[]
  coachedCourses    Course[]          @relation("CourseCoach")
  courseReviews     CourseReview[]
  badges            UserBadge[]
  streak            UserStreak?
  moduleProgress    ModuleProgress[]
  postLikes         PostLike[]
  tags              UserTag[]
  loginHistory      LoginHistory[]
  assignedCoach     User?             @relation("CoachAssignment", fields: [assignedCoachId], references: [id])
  assignedStudents  User[]            @relation("CoachAssignment")
  coachedCommunities CategoryCommunity[] @relation("CommunityCoach")
  wishlist          Wishlist[]
  dfyPurchases      DFYPurchase[]

  @@index([email])
  @@index([role])
  @@index([assignedCoachId])
  @@index([leadSource])
}

enum UserRole {
  STUDENT
  INSTRUCTOR
  MENTOR
  ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// ==================== COURSES & CONTENT ====================

model Course {
  id              String       @id @default(cuid())
  title           String
  slug            String       @unique
  description     String       @db.Text
  shortDescription String?
  thumbnail       String?
  previewVideo    String?      // Wistia video ID
  price           Decimal?     @db.Decimal(10, 2)
  isFree          Boolean      @default(false)
  isPublished     Boolean      @default(false)
  isFeatured      Boolean      @default(false)
  difficulty      Difficulty   @default(BEGINNER)
  duration        Int?         // Total duration in minutes
  certificateType CertificateType @default(COMPLETION)

  categoryId      String?
  instructorId    String?
  coachId         String?      // Assigned coach for 1:1 support

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  publishedAt     DateTime?

  // Relations
  category        Category?    @relation(fields: [categoryId], references: [id])
  coach           User?        @relation("CourseCoach", fields: [coachId], references: [id])
  modules         Module[]
  enrollments     Enrollment[]
  certificates    Certificate[]
  tags            CourseTag[]
  reviews         CourseReview[]
  analytics       CourseAnalytics?
  offers          OfferCourse[]
  wishlist        Wishlist[]

  @@index([slug])
  @@index([categoryId])
  @@index([coachId])
  @@index([isPublished])
  @@index([isFeatured])
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum CertificateType {
  COMPLETION
  CERTIFICATION
  MINI_DIPLOMA
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  courses     Course[]
  community   CategoryCommunity?

  @@index([slug])
}

model Tag {
  id        String      @id @default(cuid())
  name      String      @unique
  slug      String      @unique

  courses   CourseTag[]

  @@index([slug])
}

model CourseTag {
  courseId String
  tagId    String

  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([courseId, tagId])
}

model Module {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int      @default(0)
  isPublished Boolean  @default(false)

  courseId    String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  progress    ModuleProgress[]

  @@index([courseId])
  @@index([order])
}

model Lesson {
  id              String      @id @default(cuid())
  title           String
  description     String?     @db.Text
  content         String?     @db.Text  // Rich text content
  videoId         String?     // Wistia video ID
  videoDuration   Int?        // Duration in seconds
  order           Int         @default(0)
  isPublished     Boolean     @default(false)
  isFreePreview   Boolean     @default(false)
  lessonType      LessonType  @default(VIDEO)

  moduleId        String

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  module          Module      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress        LessonProgress[]
  resources       LessonResource[]

  @@index([moduleId])
  @@index([order])
}

enum LessonType {
  VIDEO
  TEXT
  QUIZ
  ASSIGNMENT
  LIVE_SESSION
}

model LessonResource {
  id        String   @id @default(cuid())
  title     String
  type      ResourceType
  url       String
  size      Int?     // File size in bytes

  lessonId  String

  createdAt DateTime @default(now())

  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

enum ResourceType {
  PDF
  DOCUMENT
  SPREADSHEET
  IMAGE
  AUDIO
  LINK
  OTHER
}

// ==================== ENROLLMENT & PROGRESS ====================

model Enrollment {
  id              String           @id @default(cuid())
  userId          String
  courseId        String
  status          EnrollmentStatus @default(ACTIVE)
  progress        Float            @default(0) // 0-100 percentage
  enrolledAt      DateTime         @default(now())
  completedAt     DateTime?
  expiresAt       DateTime?
  lastAccessedAt  DateTime?

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  PAUSED
  EXPIRED
  CANCELLED
}

model LessonProgress {
  id            String   @id @default(cuid())
  userId        String
  lessonId      String
  isCompleted   Boolean  @default(false)
  watchTime     Int      @default(0) // Seconds watched
  lastPosition  Int      @default(0) // Last video position in seconds
  completedAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson        Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

// ==================== CERTIFICATES ====================

model Certificate {
  id              String          @id @default(cuid())
  certificateNumber String        @unique
  userId          String
  courseId        String
  type            CertificateType
  issuedAt        DateTime        @default(now())
  expiresAt       DateTime?
  pdfUrl          String?
  verificationUrl String?

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([certificateNumber])
  @@index([userId])
}

// ==================== WISHLIST ====================

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

// ==================== MESSAGING & COMMUNITY ====================

model Message {
  id          String      @id @default(cuid())
  content     String      @db.Text
  isRead      Boolean     @default(false)
  messageType MessageType @default(DIRECT)

  // Attachment fields
  attachmentUrl  String?
  attachmentType String?   // "image", "file", "voice", "ai_voice"
  attachmentName String?
  voiceDuration  Int?      // Duration in seconds for voice messages

  // Reply threading
  replyToId   String?     // Parent message ID for replies
  replyTo     Message?    @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies     Message[]   @relation("MessageReplies")

  // AI Voice message
  isAiVoice   Boolean     @default(false) // True if generated by TTS
  transcription String?   @db.Text // Voice-to-text transcription

  // Read receipts
  readAt      DateTime?   // When the message was read

  // Scheduled messages
  scheduledAt DateTime?   // When to send the message
  isScheduled Boolean     @default(false) // True if message is scheduled

  senderId    String
  receiverId  String

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  sender      User        @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User        @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  reactions   MessageReaction[]

  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
  @@index([replyToId])
}

// Scheduled voice messages (for delayed sending)
model ScheduledVoiceMessage {
  id            String   @id @default(cuid())
  senderId      String   // Sarah coach ID
  receiverId    String   // Student to receive message
  voiceText     String   @db.Text // Text to convert to voice
  textContent   String   @db.Text // Fallback text content
  
  scheduledFor  DateTime // When to send
  sentAt        DateTime? // When actually sent
  status        String   @default("PENDING") // PENDING, PROCESSING, SENT, FAILED
  
  // For retry logic
  attempts      Int      @default(0)
  lastError     String?  @db.Text
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  sender        User     @relation("ScheduledVoiceSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver      User     @relation("ScheduledVoiceReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  
  @@index([status, scheduledFor])
  @@index([receiverId])
}
model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String   // The emoji character

  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

// Typing indicator status (stored temporarily)
model TypingStatus {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  isTyping   Boolean  @default(true)
  updatedAt  DateTime @default(now())

  @@unique([senderId, receiverId])
  @@index([receiverId])
}

enum MessageType {
  DIRECT
  SYSTEM
  NOTIFICATION
  MENTORSHIP
}

model CommunityPost {
  id          String        @id @default(cuid())
  title       String
  content     String        @db.Text
  isPinned    Boolean       @default(false)
  isLocked    Boolean       @default(false)
  viewCount   Int           @default(0)
  likeCount   Int           @default(0)

  authorId    String
  categoryId  String?       // Legacy: general category like "tips", "wins"
  communityId String?       // Links to category-based community

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  community   CategoryCommunity? @relation(fields: [communityId], references: [id], onDelete: SetNull)
  comments    PostComment[]
  likes       PostLike[]

  @@index([authorId])
  @@index([isPinned])
  @@index([communityId])
}

model PostLike {
  id        String        @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime      @default(now())

  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model PostComment {
  id        String   @id @default(cuid())
  content   String   @db.Text

  postId    String
  authorId  String
  parentId  String?  // For nested replies

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent    PostComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   PostComment[] @relation("CommentReplies")

  @@index([postId])
  @@index([authorId])
}

// ==================== MENTORSHIP ====================

model MentorSession {
  id          String        @id @default(cuid())
  mentorId    String
  studentId   String
  status      SessionStatus @default(PENDING)
  scheduledAt DateTime?
  duration    Int?          // Duration in minutes
  notes       String?       @db.Text
  meetingUrl  String?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  mentor      User          @relation("MentorSessions", fields: [mentorId], references: [id], onDelete: Cascade)
  student     User          @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([mentorId])
  @@index([studentId])
  @@index([status])
}

enum SessionStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?            // Additional data for the notification
  isRead    Boolean          @default(false)

  createdAt DateTime         @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
}

enum NotificationType {
  LESSON_COMPLETE
  MODULE_COMPLETE
  COURSE_COMPLETE
  CERTIFICATE_ISSUED
  NEW_MESSAGE
  MENTOR_REQUEST
  COMMUNITY_REPLY
  SYSTEM
  PROMOTION
}

// ==================== WEBHOOKS & EVENTS ====================

model WebhookEvent {
  id          String   @id @default(cuid())
  eventType   String
  payload     Json
  status      String   @default("pending") // pending, sent, failed
  attempts    Int      @default(0)
  lastError   String?

  createdAt   DateTime @default(now())
  processedAt DateTime?

  @@index([eventType])
  @@index([status])
}

model WebhookEndpoint {
  id          String   @id @default(cuid())
  url         String
  secret      String
  events      String[] // Array of event types to subscribe to
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// ==================== BULK COMMUNICATIONS ====================

model BulkEmail {
  id          String          @id @default(cuid())
  subject     String
  content     String          @db.Text
  status      BulkEmailStatus @default(DRAFT)
  recipientType String        // all, enrolled, completed, etc.
  filters     Json?           // Additional filters for recipients
  sentCount   Int             @default(0)
  failedCount Int             @default(0)
  scheduledAt DateTime?
  sentAt      DateTime?

  senderId    String?
  sender      User?           @relation("BulkEmailSender", fields: [senderId], references: [id])

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([status])
  @@index([senderId])
}

enum BulkEmailStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

model BulkDM {
  id            String        @id @default(cuid())
  content       String        @db.Text
  status        BulkEmailStatus @default(DRAFT)
  recipientType String
  filters       Json?
  sentCount     Int           @default(0)
  failedCount   Int           @default(0)
  scheduledAt   DateTime?
  sentAt        DateTime?

  senderId      String?
  sender        User?         @relation("BulkDMSender", fields: [senderId], references: [id])

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([status])
  @@index([senderId])
}

// ==================== ANALYTICS ====================

model CourseAnalytics {
  id            String   @id @default(cuid())
  courseId      String   @unique
  totalEnrolled Int      @default(0)
  totalCompleted Int     @default(0)
  avgProgress   Float    @default(0)
  avgRating     Float    @default(0)
  totalRevenue  Decimal  @default(0) @db.Decimal(12, 2)

  updatedAt     DateTime @updatedAt

  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model UserActivity {
  id        String   @id @default(cuid())
  userId    String
  action    String
  metadata  Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ==================== COURSE REVIEWS ====================

model CourseReview {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  rating    Int      // 1-5 stars
  title     String?
  content   String   @db.Text
  isPublic  Boolean  @default(true)
  isVerified Boolean @default(false) // Verified purchase

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([rating])
}

// ==================== GAMIFICATION ====================

model Badge {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String
  icon        String   // Icon name or emoji
  color       String   // Hex color
  criteria    String   // Description of how to earn
  points      Int      @default(0)

  createdAt   DateTime @default(now())

  userBadges  UserBadge[]

  @@index([slug])
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  metadata  Json?    // Extra info (e.g., which course)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model UserStreak {
  id            String   @id @default(cuid())
  userId        String   @unique
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastActiveAt  DateTime @default(now())
  totalPoints   Int      @default(0)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== MODULE PROGRESS ====================

model ModuleProgress {
  id          String    @id @default(cuid())
  userId      String
  moduleId    String
  isCompleted Boolean   @default(false)
  completedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  module      Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
}

// ==================== USER TAGS & TRACKING ====================

model UserTag {
  id        String   @id @default(cuid())
  userId    String
  tag       String   // e.g., "lead:herbalism", "lifecycle:enrolled", "interest:functional-medicine"
  value     String?  // Optional value (e.g., course ID, specific detail)
  metadata  Json?    // Extra data for automation
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tag])
  @@index([userId])
  @@index([tag])
}

model LoginHistory {
  id           String   @id @default(cuid())
  userId       String
  ipAddress    String?
  userAgent    String?
  location     String?  // City, Country (from IP geolocation)
  device       String?  // Desktop, Mobile, Tablet
  browser      String?  // Chrome, Safari, Firefox, etc.
  isFirstLogin Boolean  @default(false)
  loginMethod  String?  // credentials, google, magic-link
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([isFirstLogin])
}

// ==================== NICHE COACH ASSIGNMENT ====================

model NicheCoach {
  id          String   @id @default(cuid())
  niche       String   @unique // e.g., "functional-medicine", "womens-health", "gut-health"
  coachId     String
  displayName String   // e.g., "Functional Medicine", "Women's Health"
  description String?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([niche])
  @@index([coachId])
}

// ==================== CATEGORY COMMUNITIES ====================

model CategoryCommunity {
  id          String   @id @default(cuid())
  categoryId  String   @unique
  name        String
  description String?  @db.Text
  welcomePost String?  @db.Text  // Pinned welcome message
  coachId     String   // Primary coach for this community
  isActive    Boolean  @default(true)
  memberCount Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  coach       User     @relation("CommunityCoach", fields: [coachId], references: [id])
  posts       CommunityPost[]

  @@index([categoryId])
  @@index([coachId])
  @@index([isActive])
}

// ==================== AUTO MESSAGES ====================

model AutoMessage {
  id           String   @id @default(cuid())
  trigger      String   // first_login, enrollment, inactive_7d, course_complete, etc.
  triggerValue String?  // Optional: specific course ID, category, etc.
  fromCoachId  String?  // If null, uses student's assigned coach
  subject      String?  // For emails
  content      String   @db.Text
  messageType  String   @default("dm") // dm, email, notification
  isActive     Boolean  @default(true)
  delayMinutes Int      @default(0) // Delay before sending
  priority     Int      @default(0) // Higher = sent first

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([trigger])
  @@index([isActive])
}

// ==================== SPECIAL OFFERS & PROMOTIONS ====================

model SpecialOffer {
  id              String   @id @default(cuid())
  title           String
  description     String?  @db.Text
  code            String?  @unique // Promo code if applicable
  discountType    String   // percentage, fixed_amount
  discountValue   Decimal  @db.Decimal(10, 2) // Amount or percentage
  minPurchase     Decimal? @db.Decimal(10, 2) // Minimum purchase amount
  maxUses         Int?     // Max total uses
  maxUsesPerUser  Int?     // Max uses per user
  usedCount       Int      @default(0)
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false) // Show in banner
  startsAt        DateTime @default(now())
  expiresAt       DateTime?
  bannerColor     String?  // Gradient or color for UI
  bannerIcon      String?  // Icon name

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Many-to-many relation with courses
  courses         OfferCourse[]
  redemptions     OfferRedemption[]

  @@index([isActive])
  @@index([code])
  @@index([startsAt])
  @@index([expiresAt])
}

model OfferCourse {
  id        String       @id @default(cuid())
  offerId   String
  courseId  String

  offer     SpecialOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  course    Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([offerId, courseId])
  @@index([offerId])
  @@index([courseId])
}

model OfferRedemption {
  id        String       @id @default(cuid())
  offerId   String
  userId    String
  courseId  String?
  savedAmount Decimal    @db.Decimal(10, 2) // Amount saved

  createdAt DateTime     @default(now())

  offer     SpecialOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@index([userId])
}

// ==================== WORKFLOW AUTOMATION ENGINE ====================

model Workflow {
  id              String         @id @default(cuid())
  name            String
  slug            String         @unique
  description     String?        @db.Text
  category        WorkflowCategory
  triggerType     TriggerType
  triggerConfig   Json           // Configuration for the trigger (courseId, creditScore range, etc.)
  isActive        Boolean        @default(false)
  isSystem        Boolean        @default(false) // System workflows can't be deleted
  priority        Int            @default(0) // Higher = runs first
  cooldownMinutes Int            @default(0) // Prevent re-triggering for X minutes
  maxExecutions   Int?           // Max times this workflow can run per user

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  actions         WorkflowAction[]
  conditions      WorkflowCondition[]
  executions      WorkflowExecution[]

  @@index([triggerType])
  @@index([isActive])
  @@index([category])
}

enum WorkflowCategory {
  ENROLLMENT         // Welcome, onboarding
  PROGRESS           // Lesson/module/course completion
  ENGAGEMENT         // Inactivity, streaks, community
  UPSELL             // Credit-based offers, upgrades
  MILESTONE          // Badges, certificates, achievements
  BEHAVIOR           // Catalog views, page visits
  SYSTEM             // Tech automations, tagging
  ANNOUNCEMENT       // Bulk communications
}

enum TriggerType {
  // Enrollment triggers
  USER_REGISTERED
  USER_FIRST_LOGIN
  USER_ENROLLED
  USER_ONBOARDING_COMPLETE

  // Progress triggers
  LESSON_COMPLETED
  MODULE_COMPLETED
  COURSE_COMPLETED
  MINI_DIPLOMA_EARNED
  CERTIFICATION_EARNED
  CHALLENGE_HALFWAY
  CHALLENGE_COMPLETED
  PROGRESS_PERCENTAGE   // 25%, 50%, 75%, etc.

  // Engagement triggers
  INACTIVE_24H
  INACTIVE_48H
  INACTIVE_7D
  STREAK_ACHIEVED       // X days in a row
  FIRST_COMMUNITY_POST
  FIRST_COMMUNITY_COMMENT

  // Behavior triggers
  CATALOG_VIEWED        // Viewed catalog X times
  COURSE_PAGE_VIEWED    // Viewed specific course page
  PRICING_PAGE_VIEWED
  VIDEO_WATCHED_PERCENT // Watched X% of video

  // Credit/Finance triggers
  CREDIT_SCORE_UNDER_620
  CREDIT_SCORE_620_679
  CREDIT_SCORE_680_PLUS

  // Time-based triggers
  DAYS_SINCE_ENROLLMENT // X days after enrolling
  DAYS_SINCE_LAST_LOGIN
  SCHEDULED             // Cron-like scheduling

  // Badge/Achievement triggers
  BADGE_EARNED
  CERTIFICATE_ISSUED

  // Manual triggers
  MANUAL               // Triggered manually by admin
}

model WorkflowAction {
  id            String       @id @default(cuid())
  workflowId    String
  order         Int          @default(0)
  actionType    ActionType
  config        Json         // Action-specific configuration
  delayMinutes  Int          @default(0) // Delay before executing this action
  isActive      Boolean      @default(true)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  workflow      Workflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  executions    ActionExecution[]

  @@index([workflowId])
  @@index([order])
}

enum ActionType {
  // Communication actions
  SEND_DM
  SEND_EMAIL
  SEND_NOTIFICATION

  // User actions
  ADD_TAG
  REMOVE_TAG
  ASSIGN_COACH
  UPDATE_USER_FIELD

  // Content actions
  UNLOCK_COURSE
  UNLOCK_MODULE
  UNLOCK_LESSON
  GRANT_ACCESS

  // Gamification actions
  AWARD_BADGE
  ADD_POINTS
  UPDATE_STREAK

  // UI actions
  SHOW_POPUP
  SHOW_OFFER
  REDIRECT_TO_PAGE
  SHOW_UPSELL_CTA

  // Integration actions
  WEBHOOK_CALL
  ZAPIER_TRIGGER

  // Workflow actions
  WAIT
  CONDITIONAL_BRANCH
  TRIGGER_WORKFLOW
}

model WorkflowCondition {
  id            String       @id @default(cuid())
  workflowId    String
  field         String       // User field to check (creditScore, role, tags, etc.)
  operator      ConditionOperator
  value         String       // Value to compare against
  logicalOp     LogicalOperator @default(AND)
  order         Int          @default(0)

  createdAt     DateTime     @default(now())

  workflow      Workflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

enum ConditionOperator {
  EQUALS
  NOT_EQUALS
  GREATER_THAN
  LESS_THAN
  GREATER_OR_EQUAL
  LESS_OR_EQUAL
  CONTAINS
  NOT_CONTAINS
  IN_LIST
  NOT_IN_LIST
  IS_EMPTY
  IS_NOT_EMPTY
  HAS_TAG
  NOT_HAS_TAG
}

enum LogicalOperator {
  AND
  OR
}

model WorkflowExecution {
  id            String            @id @default(cuid())
  workflowId    String
  userId        String
  status        ExecutionStatus   @default(PENDING)
  triggerData   Json?             // Data that triggered the workflow
  startedAt     DateTime          @default(now())
  completedAt   DateTime?
  errorMessage  String?           @db.Text
  metadata      Json?             // Additional execution data

  workflow      Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  actions       ActionExecution[]

  @@index([workflowId])
  @@index([userId])
  @@index([status])
  @@index([startedAt])
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  WAITING     // Waiting for delay/condition
}

model ActionExecution {
  id                String            @id @default(cuid())
  executionId       String
  actionId          String
  status            ExecutionStatus   @default(PENDING)
  result            Json?             // Result of the action
  errorMessage      String?           @db.Text
  scheduledFor      DateTime?         // When to execute (for delays)
  executedAt        DateTime?

  execution         WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  action            WorkflowAction    @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([actionId])
  @@index([status])
  @@index([scheduledFor])
}

// ==================== MESSAGE TEMPLATES ====================

model MessageTemplate {
  id            String          @id @default(cuid())
  name          String
  slug          String          @unique
  category      TemplateCategory
  subject       String?         // For emails
  content       String          @db.Text
  variables     String[]        // Available placeholders: firstName, courseName, etc.
  isActive      Boolean         @default(true)
  isSystem      Boolean         @default(false)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([category])
  @@index([isActive])
}

enum TemplateCategory {
  WELCOME
  PROGRESS
  ENCOURAGEMENT
  UPSELL
  REMINDER
  MILESTONE
  ANNOUNCEMENT
  SUPPORT
}

// ==================== USER CREDIT SCORE (SmartRoute) ====================

model UserCreditProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  creditScore     Int?      // Actual credit score if provided
  creditTier      CreditTier @default(UNKNOWN)
  incomeRange     String?   // e.g., "50k-75k"
  employmentStatus String?
  financingInterest Boolean @default(false)
  lastUpdated     DateTime  @default(now())

  // Calculated fields for SmartRoute
  recommendedTier String?   // low, mid, high based on behavior

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([creditTier])
}

enum CreditTier {
  UNKNOWN
  UNDER_620
  TIER_620_679
  TIER_680_PLUS
}

// ==================== BEHAVIOR TRACKING ====================

model UserBehavior {
  id            String    @id @default(cuid())
  userId        String
  behaviorType  String    // catalog_view, course_page_view, pricing_view, etc.
  entityId      String?   // courseId, pageId, etc.
  count         Int       @default(1)
  metadata      Json?
  lastOccurred  DateTime  @default(now())

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, behaviorType, entityId])
  @@index([userId])
  @@index([behaviorType])
  @@index([lastOccurred])
}

// ==================== SCHEDULED JOBS ====================

model ScheduledJob {
  id            String      @id @default(cuid())
  jobType       String      // workflow_action, bulk_email, reminder, etc.
  referenceId   String?     // ID of the related entity
  userId        String?     // Target user if applicable
  payload       Json        // Job-specific data
  scheduledFor  DateTime
  status        JobStatus   @default(PENDING)
  attempts      Int         @default(0)
  maxAttempts   Int         @default(3)
  lastError     String?     @db.Text
  executedAt    DateTime?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([jobType])
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ==================== CHALLENGES ====================

model Challenge {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  description   String    @db.Text
  thumbnail     String?
  durationDays  Int       @default(7)
  unlockTime    String    @default("08:00") // Time to unlock next day
  isActive      Boolean   @default(true)
  isFeatured    Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  modules       ChallengeModule[]
  enrollments   ChallengeEnrollment[]
  badges        ChallengeBadge[]
  
  @@index([slug])
  @@index([isActive])
}

model ChallengeModule {
  id              String    @id @default(cuid())
  challengeId     String
  day             Int       // Day 1, 2, 3...
  title           String
  description     String?   @db.Text
  videoId         String?   // Wistia video ID
  content         String?   @db.Text // Rich text content
  actionTask      String?   @db.Text // Daily action task
  communityPrompt String?   // Prompt for community discussion
  
  createdAt       DateTime  @default(now())
  
  challenge       Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  
  @@unique([challengeId, day])
  @@index([challengeId])
}

model ChallengeEnrollment {
  id              String    @id @default(cuid())
  userId          String
  challengeId     String
  startedAt       DateTime  @default(now())
  currentDay      Int       @default(1)
  completedDays   Int[]     @default([])
  completedAt     DateTime?
  
  challenge       Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, challengeId])
  @@index([userId])
  @@index([challengeId])
}

model ChallengeBadge {
  id              String    @id @default(cuid())
  challengeId     String
  day             Int       // 0 = enrollment badge, 7 = completion badge
  name            String
  icon            String    // Emoji or icon name
  description     String?
  
  challenge       Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  
  @@unique([challengeId, day])
  @@index([challengeId])
}

// ==================== DFY RESOURCES ====================

model Resource {
  id            String          @id @default(cuid())
  title         String
  description   String?         @db.Text
  thumbnail     String?
  category      ResourceCategory
  accessLevel   ResourceAccess  @default(FREE)
  downloadCount Int             @default(0)
  isActive      Boolean         @default(true)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  files         ResourceFile[]
  
  @@index([category])
  @@index([accessLevel])
}

model ResourceFile {
  id          String    @id @default(cuid())
  resourceId  String
  name        String
  url         String
  fileType    String    // pdf, docx, xlsx, etc.
  size        Int?      // File size in bytes
  
  createdAt   DateTime  @default(now())
  
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  @@index([resourceId])
}

enum ResourceCategory {
  COACHING_PROGRAM
  MEAL_PLAN
  PROTOCOL
  CLIENT_MATERIALS
  BUSINESS_TEMPLATES
  SOCIAL_MEDIA
  WORKSHEETS
  OTHER
}

enum ResourceAccess {
  FREE
  ENROLLED
  CERTIFIED
  PREMIUM
}

// ==================== COACH CRM ====================

model Client {
  id              String        @id @default(cuid())
  coachId         String
  name            String
  email           String?
  phone           String?
  avatar          String?
  notes           String?       @db.Text
  tags            String[]
  status          ClientStatus  @default(ACTIVE)
  
  // Personal Info
  dateOfBirth     DateTime?
  gender          String?
  occupation      String?
  timezone        String?
  
  // Health Profile
  primaryConcerns String?       @db.Text  // Main health concerns
  healthGoals     String?       @db.Text  // What they want to achieve
  currentHealth   String?       @db.Text  // Current health status overview
  
  // Health History
  conditions      String[]      // Diagnosed conditions
  medications     String[]      // Current medications
  supplements     String[]      // Current supplements
  allergies       String[]      // Known allergies
  surgeries       String?       @db.Text  // Past surgeries
  familyHistory   String?       @db.Text  // Family health history
  
  // Lifestyle
  dietType        String?       // Vegan, Paleo, etc.
  sleepHours      Float?        // Average sleep
  exerciseFreq    String?       // How often they exercise
  stressLevel     Int?          // 1-10 scale
  
  // Assessments (tracked over time as JSON array)
  assessments     Json?         // [{date, type, score, notes}]
  
  // Coaching
  startDate       DateTime?     // When coaching started
  packageType     String?       // 4-week, 8-week, etc.
  nextSession     DateTime?     // Next scheduled session
  lastSession     DateTime?     // Last session date
  totalSessions   Int           @default(0)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  sessions        ClientSession[]
  protocols       ClientProtocol[]
  tasks           ClientTask[]
  
  @@index([coachId])
  @@index([status])
}

model ClientSession {
  id          String    @id @default(cuid())
  clientId    String
  date        DateTime
  duration    Int?      // Duration in minutes
  notes       String?   @db.Text
  sessionType String?   // Initial, Follow-up, Check-in
  
  createdAt   DateTime  @default(now())
  
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId])
  @@index([date])
}

model ClientProtocol {
  id          String          @id @default(cuid())
  clientId    String
  name        String
  description String?
  steps       Json            // Array of protocol steps
  startDate   DateTime?
  endDate     DateTime?
  status      ProtocolStatus  @default(ACTIVE)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  client      Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId])
}

model ClientTask {
  id          String    @id @default(cuid())
  clientId    String
  task        String
  description String?
  dueDate     DateTime?
  completed   Boolean   @default(false)
  completedAt DateTime?
  priority    String?   // low, medium, high
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId])
  @@index([dueDate])
  @@index([completed])
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  COMPLETED
  PAUSED
}

enum ProtocolStatus {
  DRAFT
  ACTIVE
  COMPLETED
  PAUSED
}

// ==================== EBOOKS / LIBRARY ====================

model Ebook {
  id            String    @id @default(cuid())
  title         String
  author        String?
  description   String?   @db.Text
  coverImage    String?
  isFeatured    Boolean   @default(false)
  isPublished   Boolean   @default(false)
  accessLevel   ResourceAccess @default(FREE)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  chapters      EbookChapter[]
  progress      EbookProgress[]
  
  @@index([isPublished])
}

model EbookChapter {
  id          String    @id @default(cuid())
  ebookId     String
  title       String
  content     String    @db.Text
  order       Int       @default(0)
  
  createdAt   DateTime  @default(now())
  
  ebook       Ebook     @relation(fields: [ebookId], references: [id], onDelete: Cascade)
  
  @@index([ebookId])
  @@index([order])
}

model EbookProgress {
  id              String    @id @default(cuid())
  userId          String
  ebookId         String
  currentChapter  Int       @default(0)
  completedAt     DateTime?
  bookmarks       Json?     // Array of bookmarked positions
  highlights      Json?     // Array of highlights
  
  updatedAt       DateTime  @updatedAt
  
  ebook           Ebook     @relation(fields: [ebookId], references: [id], onDelete: Cascade)
  
  @@unique([userId, ebookId])
  @@index([userId])
  @@index([ebookId])
}

// ==================== DFY BUSINESS KITS MARKETPLACE ====================

model DFYProduct {
  id                String          @id @default(cuid())
  title             String
  slug              String          @unique
  description       String          @db.Text
  shortDescription  String?
  thumbnail         String?
  previewImage      String?         // Mockup image showing what's included
  price             Decimal         @db.Decimal(10, 2)
  compareAtPrice    Decimal?        @db.Decimal(10, 2) // Strike-through price
  productType       DFYProductType
  category          String          // functional-medicine, gut-health, hormones
  specialty         String?         // detox, menopause, adrenal, etc.
  duration          String?         // 4-week, 8-week, 12-week, 6-month
  sessionsCount     Int?            // Number of coaching sessions
  materialsCount    Int?            // Number of materials/files included
  isActive          Boolean         @default(true)
  isFeatured        Boolean         @default(false)
  isBestseller      Boolean         @default(false)
  sortOrder         Int             @default(0)
  
  // Reviews
  avgRating         Float           @default(5.0)
  reviewCount       Int             @default(0)
  
  // What's included - feature bullets
  features          String[]        // Array of feature descriptions
  highlights        String[]        // Key selling points
  
  // For bundles
  bundleProductIds  String[]        // IDs of products in this bundle
  bundleDiscount    Decimal?        @db.Decimal(10, 2) // Bundle savings
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  files             DFYProductFile[]
  purchases         DFYPurchase[]
  
  @@index([slug])
  @@index([category])
  @@index([specialty])
  @@index([productType])
  @@index([isActive])
  @@index([isFeatured])
}

enum DFYProductType {
  CORE_PROGRAM      // 4-week, 8-week, 12-week, 6-month programs
  SPECIALTY_KIT     // Focused kits (Detox, Gut Reset, Hormone, etc.)
  BUNDLE            // Multiple products together at discount
  TEMPLATE_PACK     // Forms, worksheets, assessments
  MARKETING_KIT     // Social media, email templates
  EBOOK             // E-Books and guided reading materials
}

model DFYProductFile {
  id          String    @id @default(cuid())
  productId   String
  name        String
  description String?
  fileUrl     String
  fileType    String    // pdf, docx, xlsx, zip, mp4, canva
  fileSize    Int?      // Size in bytes
  category    String?   // client-materials, marketing, session-scripts, etc.
  sortOrder   Int       @default(0)
  
  createdAt   DateTime  @default(now())
  
  product     DFYProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
  @@index([category])
}

model DFYPurchase {
  id              String      @id @default(cuid())
  userId          String
  productId       String
  purchasePrice   Decimal     @db.Decimal(10, 2)
  discountApplied Decimal?    @db.Decimal(10, 2)
  promoCode       String?
  status          PurchaseStatus @default(COMPLETED)
  
  createdAt       DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         DFYProduct  @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([status])
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  REFUNDED
}

// Coach Program Templates (unlocked via DFY purchases)
model CoachProgramTemplate {
  id              String    @id @default(cuid())
  coachId         String    // The coach who owns this template
  dfyProductId    String?   // Source DFY product if unlocked via purchase
  name            String
  description     String?
  duration        Int       // Duration in weeks
  structure       Json      // Program structure: {weeks: [{title, sessions, tasks}]}
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([coachId])
  @@index([dfyProductId])
}

