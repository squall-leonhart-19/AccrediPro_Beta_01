// AccrediPro LMS Database Schema
// Premium LMS for 40+ US Women - Certifications & Mini-Diplomas

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== USER & AUTH ====================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  emailVerified     DateTime?
  passwordHash      String?
  firstName         String?
  lastName          String?
  avatar            String?
  bio               String?
  role              UserRole  @default(STUDENT)
  isActive          Boolean   @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  accounts          Account[]
  sessions          Session[]
  enrollments       Enrollment[]
  progress          LessonProgress[]
  certificates      Certificate[]
  sentMessages      Message[]         @relation("SentMessages")
  receivedMessages  Message[]         @relation("ReceivedMessages")
  communityPosts    CommunityPost[]
  postComments      PostComment[]
  notifications     Notification[]
  mentorSessions    MentorSession[]   @relation("MentorSessions")
  studentSessions   MentorSession[]   @relation("StudentSessions")
  passwordResets    PasswordReset[]
  coachedCourses    Course[]          @relation("CourseCoach")
  courseReviews     CourseReview[]
  badges            UserBadge[]
  streak            UserStreak?
  moduleProgress    ModuleProgress[]

  @@index([email])
  @@index([role])
}

enum UserRole {
  STUDENT
  INSTRUCTOR
  MENTOR
  ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// ==================== COURSES & CONTENT ====================

model Course {
  id              String       @id @default(cuid())
  title           String
  slug            String       @unique
  description     String       @db.Text
  shortDescription String?
  thumbnail       String?
  previewVideo    String?      // Wistia video ID
  price           Decimal?     @db.Decimal(10, 2)
  isFree          Boolean      @default(false)
  isPublished     Boolean      @default(false)
  isFeatured      Boolean      @default(false)
  difficulty      Difficulty   @default(BEGINNER)
  duration        Int?         // Total duration in minutes
  certificateType CertificateType @default(COMPLETION)

  categoryId      String?
  instructorId    String?
  coachId         String?      // Assigned coach for 1:1 support

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  publishedAt     DateTime?

  // Relations
  category        Category?    @relation(fields: [categoryId], references: [id])
  coach           User?        @relation("CourseCoach", fields: [coachId], references: [id])
  modules         Module[]
  enrollments     Enrollment[]
  certificates    Certificate[]
  tags            CourseTag[]
  reviews         CourseReview[]
  analytics       CourseAnalytics?

  @@index([slug])
  @@index([categoryId])
  @@index([coachId])
  @@index([isPublished])
  @@index([isFeatured])
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum CertificateType {
  COMPLETION
  CERTIFICATION
  MINI_DIPLOMA
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  courses     Course[]

  @@index([slug])
}

model Tag {
  id        String      @id @default(cuid())
  name      String      @unique
  slug      String      @unique

  courses   CourseTag[]

  @@index([slug])
}

model CourseTag {
  courseId String
  tagId    String

  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([courseId, tagId])
}

model Module {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int      @default(0)
  isPublished Boolean  @default(false)

  courseId    String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  progress    ModuleProgress[]

  @@index([courseId])
  @@index([order])
}

model Lesson {
  id              String      @id @default(cuid())
  title           String
  description     String?     @db.Text
  content         String?     @db.Text  // Rich text content
  videoId         String?     // Wistia video ID
  videoDuration   Int?        // Duration in seconds
  order           Int         @default(0)
  isPublished     Boolean     @default(false)
  isFreePreview   Boolean     @default(false)
  lessonType      LessonType  @default(VIDEO)

  moduleId        String

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  module          Module      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress        LessonProgress[]
  resources       LessonResource[]

  @@index([moduleId])
  @@index([order])
}

enum LessonType {
  VIDEO
  TEXT
  QUIZ
  ASSIGNMENT
  LIVE_SESSION
}

model LessonResource {
  id        String   @id @default(cuid())
  title     String
  type      ResourceType
  url       String
  size      Int?     // File size in bytes

  lessonId  String

  createdAt DateTime @default(now())

  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

enum ResourceType {
  PDF
  DOCUMENT
  SPREADSHEET
  IMAGE
  AUDIO
  LINK
  OTHER
}

// ==================== ENROLLMENT & PROGRESS ====================

model Enrollment {
  id              String           @id @default(cuid())
  userId          String
  courseId        String
  status          EnrollmentStatus @default(ACTIVE)
  progress        Float            @default(0) // 0-100 percentage
  enrolledAt      DateTime         @default(now())
  completedAt     DateTime?
  expiresAt       DateTime?
  lastAccessedAt  DateTime?

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  PAUSED
  EXPIRED
  CANCELLED
}

model LessonProgress {
  id            String   @id @default(cuid())
  userId        String
  lessonId      String
  isCompleted   Boolean  @default(false)
  watchTime     Int      @default(0) // Seconds watched
  lastPosition  Int      @default(0) // Last video position in seconds
  completedAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson        Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

// ==================== CERTIFICATES ====================

model Certificate {
  id              String          @id @default(cuid())
  certificateNumber String        @unique
  userId          String
  courseId        String
  type            CertificateType
  issuedAt        DateTime        @default(now())
  expiresAt       DateTime?
  pdfUrl          String?
  verificationUrl String?

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([certificateNumber])
  @@index([userId])
}

// ==================== MESSAGING & COMMUNITY ====================

model Message {
  id          String      @id @default(cuid())
  content     String      @db.Text
  isRead      Boolean     @default(false)
  messageType MessageType @default(DIRECT)

  senderId    String
  receiverId  String

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  sender      User        @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User        @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
}

enum MessageType {
  DIRECT
  SYSTEM
  NOTIFICATION
  MENTORSHIP
}

model CommunityPost {
  id          String        @id @default(cuid())
  title       String
  content     String        @db.Text
  isPinned    Boolean       @default(false)
  isLocked    Boolean       @default(false)
  viewCount   Int           @default(0)

  authorId    String
  categoryId  String?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments    PostComment[]

  @@index([authorId])
  @@index([isPinned])
}

model PostComment {
  id        String   @id @default(cuid())
  content   String   @db.Text

  postId    String
  authorId  String
  parentId  String?  // For nested replies

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent    PostComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   PostComment[] @relation("CommentReplies")

  @@index([postId])
  @@index([authorId])
}

// ==================== MENTORSHIP ====================

model MentorSession {
  id          String        @id @default(cuid())
  mentorId    String
  studentId   String
  status      SessionStatus @default(PENDING)
  scheduledAt DateTime?
  duration    Int?          // Duration in minutes
  notes       String?       @db.Text
  meetingUrl  String?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  mentor      User          @relation("MentorSessions", fields: [mentorId], references: [id], onDelete: Cascade)
  student     User          @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([mentorId])
  @@index([studentId])
  @@index([status])
}

enum SessionStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?            // Additional data for the notification
  isRead    Boolean          @default(false)

  createdAt DateTime         @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
}

enum NotificationType {
  LESSON_COMPLETE
  MODULE_COMPLETE
  COURSE_COMPLETE
  CERTIFICATE_ISSUED
  NEW_MESSAGE
  MENTOR_REQUEST
  COMMUNITY_REPLY
  SYSTEM
  PROMOTION
}

// ==================== WEBHOOKS & EVENTS ====================

model WebhookEvent {
  id          String   @id @default(cuid())
  eventType   String
  payload     Json
  status      String   @default("pending") // pending, sent, failed
  attempts    Int      @default(0)
  lastError   String?

  createdAt   DateTime @default(now())
  processedAt DateTime?

  @@index([eventType])
  @@index([status])
}

model WebhookEndpoint {
  id          String   @id @default(cuid())
  url         String
  secret      String
  events      String[] // Array of event types to subscribe to
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// ==================== BULK COMMUNICATIONS ====================

model BulkEmail {
  id          String          @id @default(cuid())
  subject     String
  content     String          @db.Text
  status      BulkEmailStatus @default(DRAFT)
  recipientType String        // all, enrolled, completed, etc.
  filters     Json?           // Additional filters for recipients
  sentCount   Int             @default(0)
  failedCount Int             @default(0)
  scheduledAt DateTime?
  sentAt      DateTime?

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([status])
}

enum BulkEmailStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

model BulkDM {
  id            String        @id @default(cuid())
  content       String        @db.Text
  status        BulkEmailStatus @default(DRAFT)
  recipientType String
  filters       Json?
  sentCount     Int           @default(0)
  failedCount   Int           @default(0)
  scheduledAt   DateTime?
  sentAt        DateTime?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([status])
}

// ==================== ANALYTICS ====================

model CourseAnalytics {
  id            String   @id @default(cuid())
  courseId      String   @unique
  totalEnrolled Int      @default(0)
  totalCompleted Int     @default(0)
  avgProgress   Float    @default(0)
  avgRating     Float    @default(0)
  totalRevenue  Decimal  @default(0) @db.Decimal(12, 2)

  updatedAt     DateTime @updatedAt

  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model UserActivity {
  id        String   @id @default(cuid())
  userId    String
  action    String
  metadata  Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ==================== COURSE REVIEWS ====================

model CourseReview {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  rating    Int      // 1-5 stars
  title     String?
  content   String   @db.Text
  isPublic  Boolean  @default(true)
  isVerified Boolean @default(false) // Verified purchase

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([rating])
}

// ==================== GAMIFICATION ====================

model Badge {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String
  icon        String   // Icon name or emoji
  color       String   // Hex color
  criteria    String   // Description of how to earn
  points      Int      @default(0)

  createdAt   DateTime @default(now())

  userBadges  UserBadge[]

  @@index([slug])
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  metadata  Json?    // Extra info (e.g., which course)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

model UserStreak {
  id            String   @id @default(cuid())
  userId        String   @unique
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastActiveAt  DateTime @default(now())
  totalPoints   Int      @default(0)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== MODULE PROGRESS ====================

model ModuleProgress {
  id          String    @id @default(cuid())
  userId      String
  moduleId    String
  isCompleted Boolean   @default(false)
  completedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  module      Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
}
